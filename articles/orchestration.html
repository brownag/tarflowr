<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Orchestration of Targets Pipelines with tarflowr • tarflowr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Orchestration of Targets Pipelines with tarflowr">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tarflowr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/orchestration.html">Orchestration of Targets Pipelines with tarflowr</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/brownag/tarflowr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Orchestration of Targets Pipelines with tarflowr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/brownag/tarflowr/blob/main/vignettes/orchestration.Rmd" class="external-link"><code>vignettes/orchestration.Rmd</code></a></small>
      <div class="d-none name"><code>orchestration.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to use <code>tarflowr</code> to manage
complex, hierarchical workflows. This pattern is common in scientific
research where a primary analysis pipeline needs to be run on multiple
independent datasets (e.g., different study sites, simulation
parameters, or patient cohorts).</p>
<p>We will simulate a soil science study with five distinct study sites.
Our goal is to model the relationship between soil clay content and
elevation at each site and then aggregate these models to understand the
overall trends and variability. This workflow will involve two layers of
orchestration:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Sub-Projects:</strong> For each of the five sites, we
will use <code><a href="../reference/tarflowr_run.html">tarflowr_run()</a></code> to create an independent project.
This project will calculate depth-weighted average clay content for 10
soil profiles and then fit a parabolic linear model of
<code>clay ~ elevation</code>.</p></li>
<li><p><strong>Meta-orchestrator:</strong> We will use a second,
top-level <code><a href="../reference/tarflowr_run.html">tarflowr_run()</a></code> call that uses the new helpers
(<code><a href="../reference/tarflowr_project.html">tarflowr_project()</a></code> and
<code><a href="../reference/tarflowr_run_subproject.html">tarflowr_run_subproject()</a></code>). This meta-pipeline will execute
all five sub-projects in parallel and then combine their resulting
models into a final summary table.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="setup-and-helper-functions">1. Setup and Helper Functions<a class="anchor" aria-label="anchor" href="#setup-and-helper-functions"></a>
</h2>
<p>First, we load the necessary packages and define the functions we’ll
need for our analysis.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/brownag/tarflowr/" class="external-link">tarflowr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span> </span></code></pre></div>
<p>This function <code>create_site_data()</code> creates a
realistic-looking soil dataset for a single site.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_site_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">letters</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="va">site_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># for reproducibility</span></span>
<span>    </span>
<span>    <span class="co"># Site-specific elevation range and model parameters</span></span>
<span>    <span class="va">elev_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span></span>
<span>    <span class="va">elev_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">200</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Parabolic relationship parameters</span></span>
<span>    <span class="co"># y = a(x - h)^2 + k</span></span>
<span>    <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">elev_base</span> <span class="op">+</span> <span class="va">elev_range</span> <span class="op">/</span> <span class="fl">2</span> <span class="co"># vertex x-value (mid-elevation)</span></span>
<span>    <span class="va">k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">15</span>, <span class="fl">25</span><span class="op">)</span>           <span class="co"># vertex y-value (min clay)</span></span>
<span>    <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.001</span>, <span class="fl">0.005</span><span class="op">)</span>     <span class="co"># parabola steepness</span></span>
<span>    </span>
<span>    <span class="va">pedons</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        site_id <span class="op">=</span> <span class="va">site_id</span>,</span>
<span>        pedon_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">site_id</span>, <span class="st">"_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        elevation <span class="op">=</span> <span class="va">elev_base</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="va">elev_range</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">mutate</span><span class="op">(</span>base_clay <span class="op">=</span> <span class="va">a</span> <span class="op">*</span> <span class="op">(</span><span class="va">elevation</span> <span class="op">-</span> <span class="va">h</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">k</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Generate horizon data for each pedon</span></span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pedons</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pedons</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>        <span class="va">depths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">60</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="co"># Randomly make some profiles shallow</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">depths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span>, <span class="fl">49</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        </span>
<span>        <span class="va">horizons</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>            site_id <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">site_id</span>,</span>
<span>            pedon_id <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">pedon_id</span>,</span>
<span>            elevation <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">elevation</span>,</span>
<span>            hzn_top <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">depths</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>            hzn_bottom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">depths</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>            hzn_mid <span class="op">=</span> <span class="op">(</span><span class="va">hzn_top</span> <span class="op">+</span> <span class="va">hzn_bottom</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">mutate</span><span class="op">(</span></span>
<span>                <span class="co"># Add random argillic horizon effect</span></span>
<span>                clay_pct <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">base_clay</span> <span class="op">+</span> <span class="op">(</span><span class="va">hzn_mid</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                clay_pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">5</span>, <span class="va">clay_pct</span><span class="op">)</span> <span class="co"># ensure clay is not negative</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">horizons</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function calculates depth weighted average clay content for a
single pedon’s data</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_dwa_clay</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pedon_data</span>, <span class="va">target_depth</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">dwa_data</span> <span class="op">&lt;-</span> <span class="va">pedon_data</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="va">hzn_top</span> <span class="op">&lt;</span> <span class="va">target_depth</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">mutate</span><span class="op">(</span></span>
<span>            hzn_bottom_clipped <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">hzn_bottom</span>, <span class="va">target_depth</span><span class="op">)</span>,</span>
<span>            thickness <span class="op">=</span> <span class="va">hzn_bottom_clipped</span> <span class="op">-</span> <span class="va">hzn_top</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="va">thickness</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dwa_data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">tibble</span><span class="op">(</span></span>
<span>            pedon_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pedon_data</span><span class="op">$</span><span class="va">pedon_id</span><span class="op">)</span>,</span>
<span>            elevation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pedon_data</span><span class="op">$</span><span class="va">elevation</span><span class="op">)</span>,</span>
<span>            dwa_clay <span class="op">=</span> <span class="cn">NA_real_</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Calculate DWA</span></span>
<span>    <span class="va">dwa_result</span> <span class="op">&lt;-</span> <span class="va">dwa_data</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">summarise</span><span class="op">(</span>dwa_clay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">clay_pct</span> <span class="op">*</span> <span class="va">thickness</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">thickness</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        pedon_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pedon_data</span><span class="op">$</span><span class="va">pedon_id</span><span class="op">)</span>,</span>
<span>        elevation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pedon_data</span><span class="op">$</span><span class="va">elevation</span><span class="op">)</span>,</span>
<span>        dwa_clay <span class="op">=</span> <span class="va">dwa_result</span><span class="op">$</span><span class="va">dwa_clay</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit_clay_elevation_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dwa_clay_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">site_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">dwa_clay_list</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">dwa_clay</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dwa_clay</span> <span class="op">~</span> <span class="va">elevation</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">site_data</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        tidy <span class="op">=</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu">tidy</span><span class="op">(</span><span class="va">model</span><span class="op">)</span>,</span>
<span>        glance <span class="op">=</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu">glance</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-and-run-the-individual-site-sub-projects">2. Generate and Run the Individual Site Sub-Projects<a class="anchor" aria-label="anchor" href="#generate-and-run-the-individual-site-sub-projects"></a>
</h2>
<p>Now, we will loop through our desired sites (A-E), generate the data
for each, and run a <code>tarflowr</code> project for each one. This
will create five independent, cached, and reproducible analyses.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span><span class="op">)</span></span>
<span><span class="va">sub_project_dirs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">site</span> <span class="kw">in</span> <span class="va">site_ids</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">project_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"site_"</span>, <span class="va">site</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">sub_project_dirs</span><span class="op">[[</span><span class="va">site</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">project_path</span></span>
<span>    </span>
<span>    <span class="va">site_data</span> <span class="op">&lt;-</span> <span class="fu">create_site_data</span><span class="op">(</span><span class="va">site</span><span class="op">)</span></span>
<span>    <span class="va">site_work_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">site_data</span>, <span class="va">site_data</span><span class="op">$</span><span class="va">pedon_id</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="../reference/tarflowr_run.html">tarflowr_run</a></span><span class="op">(</span></span>
<span>        work_units <span class="op">=</span> <span class="va">site_work_units</span>,</span>
<span>        process_func <span class="op">=</span> <span class="va">calculate_dwa_clay</span>,</span>
<span>        combine_func <span class="op">=</span> <span class="va">fit_clay_elevation_model</span>,</span>
<span>        project_dir <span class="op">=</span> <span class="va">project_path</span>,</span>
<span>        result_target_name <span class="op">=</span> <span class="st">"site_model_summary"</span>,</span>
<span>        packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"broom"</span><span class="op">)</span>,</span>
<span>        callr_function <span class="op">=</span> <span class="fu">callr</span><span class="fu">::</span><span class="va"><a href="https://callr.r-lib.org/reference/r_bg.html" class="external-link">r_bg</a></span>,</span>
<span>        workers <span class="op">=</span> <span class="fl">2</span> <span class="co"># Use 2 workers for the inner loop</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="orchestrate-sub-projects-with-a-hierarchical-workflow">3. Orchestrate Sub-Projects with a Hierarchical Workflow<a class="anchor" aria-label="anchor" href="#orchestrate-sub-projects-with-a-hierarchical-workflow"></a>
</h2>
<p>With our five sub-projects completed, we can now use the hierarchical
workflow helpers to run them all as a single meta-pipeline. This
demonstrates how you could re-run or update all sites in parallel.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hierarchical_work_units</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">sub_project_dirs</span>, <span class="op">~</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/tarflowr_project.html">tarflowr_project</a></span><span class="op">(</span></span>
<span>        project_dir <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        result_target <span class="op">=</span> <span class="va">site_model_summary</span> </span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summarize_all_models</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_summary_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model_summary_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">'c'</span>, <span class="va">model_summary_list</span><span class="op">)</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">model_summary_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">glance</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">'rbind'</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">model_summary_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">tidy</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">group_by</span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">summarize</span><span class="op">(</span></span>
<span>            mean_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>            sd_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>        <span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        coef_summary <span class="op">=</span> <span class="va">cs</span>, </span>
<span>        site_stats <span class="op">=</span> <span class="va">s</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">meta_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tarflowr_run.html">tarflowr_run</a></span><span class="op">(</span></span>
<span>    work_units <span class="op">=</span> <span class="va">hierarchical_work_units</span>,</span>
<span>    process_func <span class="op">=</span> <span class="va">tarflowr_run_subproject</span>,</span>
<span>    combine_func <span class="op">=</span> <span class="va">summarize_all_models</span>,</span>
<span>    project_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"_meta_analysis"</span><span class="op">)</span>,</span>
<span>    workers <span class="op">=</span> <span class="fl">2</span> <span class="co"># Run 2 sub-projects in parallel</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="final-results">4. Final Results<a class="anchor" aria-label="anchor" href="#final-results"></a>
</h2>
<p>The meta-orchestrator has combined the results from all five sites.
We can now view the final summary tables.</p>
<div class="section level3">
<h3 id="site-specific-model-fit-statistics">Site-Specific Model Fit Statistics<a class="anchor" aria-label="anchor" href="#site-specific-model-fit-statistics"></a>
</h3>
<p>This table shows the R-squared and RMSE for the parabolic model at
each individual site.</p>
</div>
<div class="section level3">
<h3 id="overall-model-parameter-summary">Overall Model Parameter Summary<a class="anchor" aria-label="anchor" href="#overall-model-parameter-summary"></a>
</h3>
<p>This table shows the mean and standard deviation of the model
coefficients (intercept, elevation, and elevation-squared) across all
five sites, giving us an idea of the overall trend and its
variability.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette demonstrates <code>tarflowr</code>’s hierarchical
workflow capabilities. We were able to:</p>
<ul>
<li><p>Define a complex, multi-step analysis for a single study
site.</p></li>
<li><p>Use <code>tarflowr</code> to create and run this analysis
independently for five sites.</p></li>
<li><p>Use <code>tarflowr</code>’s meta-orchestration helpers
(<code>tarflowr_project</code> and <code>tarflowr_run_subproject</code>)
to run all five site-level pipelines as a single, parallelized
workflow.</p></li>
<li><p>Aggregate the results from each independent pipeline into a
final, comprehensive summary.</p></li>
</ul>
<p>This pattern provides a scalable, reproducible, and organized way to
manage large-scale research projects.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Brown.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
